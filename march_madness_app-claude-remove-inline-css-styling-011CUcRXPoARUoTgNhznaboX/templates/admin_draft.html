<!-- templates/admin_draft.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Assignment (Draft) - March Madness Madness</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a href="{{ url_for('home') }}" class="navbar-brand">March Madness Madness</a>
      <span class="badge bg-warning text-dark">Draft Interface</span>
    </div>
  </nav>

  <main class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col">
        <h1 class="h3">Team Assignment (Draft) - {{ year }}</h1>
        <p class="text-muted">
          Assign the 64 tournament teams to your 16 participants. Each participant gets 4 teams (one from each region).
          <a href="{{ url_for('admin') }}" class="btn btn-sm btn-outline-secondary ms-3">← Back to Admin</a>
        </p>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">⚡ Quick Actions</h5>
            <div class="btn-group" role="group">
              <!-- Random Assignment -->
              <form method="post" action="{{ url_for('admin_draft_random') }}" class="inline-form" onsubmit="return confirm('Randomly assign all teams? This will overwrite any existing assignments.');">
                <input type="hidden" name="year" value="{{ year }}">
                <button type="submit" class="btn btn-success">
                  🎲 Random Assignment
                </button>
              </form>

              <!-- Reset -->
              <form method="post" action="{{ url_for('admin_draft_reset') }}" class="inline-form-with-margin" onsubmit="return confirm('Clear all assignments? This cannot be undone.');">
                <input type="hidden" name="year" value="{{ year }}">
                <button type="submit" class="btn btn-warning">
                  🔄 Reset All
                </button>
              </form>
            </div>
            <p class="text-muted small mt-2 mb-0">
              <strong>Random Assignment:</strong> Automatically assigns teams fairly (one per region to each participant). 
              <strong>Reset:</strong> Clears all assignments to start over.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Assignment Progress -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card shadow-sm">
          <div class="card-header">
            <strong>📊 Assignment Progress</strong>
          </div>
          <div class="card-body">
            <div class="row">
              {% for participant in participants %}
              <div class="col-md-3 col-sm-6 mb-2">
                <div class="card {% if assignment_stats[participant.id].complete %}border-success{% elif assignment_stats[participant.id].total > 0 %}border-warning{% endif %}">
                  <div class="card-body p-2">
                    <h6 class="card-title mb-1">
                      {{ participant.name }}
                      {% if assignment_stats[participant.id].complete %}
                        <span class="badge bg-success complete-badge">✓</span>
                      {% endif %}
                    </h6>
                    <p class="card-text small mb-0">
                      <strong>{{ assignment_stats[participant.id].total }}/4</strong> teams
                      <br>
                      <span class="text-muted region-text-small">
                        E:{{ assignment_stats[participant.id].regions.East }}
                        W:{{ assignment_stats[participant.id].regions.West }}
                        S:{{ assignment_stats[participant.id].regions.South }}
                        M:{{ assignment_stats[participant.id].regions.Midwest }}
                      </span>
                    </p>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Assignment Form -->
    <form method="post" action="{{ url_for('admin_draft_assign') }}" id="draftForm">
      <input type="hidden" name="year" value="{{ year }}">
      
      <!-- Regions -->
      {% for region in ["East", "West", "South", "Midwest"] %}
        {% if region in teams_by_region %}
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <strong>🏀 {{ region }} Region</strong> ({{ teams_by_region[region]|length }} teams)
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0 draft-table">
                <thead class="table-light">
                  <tr>
                    <th>Seed</th>
                    <th>Team</th>
                    <th>Assign To</th>
                  </tr>
                </thead>
                <tbody>
                  {% for team in teams_by_region[region] %}
                  <tr class="team-row">
                    <td class="text-center">
                      <span class="badge bg-secondary">{{ team.seed }}</span>
                    </td>
                    <td>
                      <strong>{{ team.name }}</strong>
                    </td>
                    <td>
                      <select 
                        name="team_{{ team.id }}" 
                        class="form-select form-select-sm"
                        data-region="{{ region }}"
                      >
                        <option value="">-- Not Assigned --</option>
                        {% for participant in participants %}
                        <option 
                          value="{{ participant.id }}"
                          {% if team.initial_owner_id == participant.id %}selected{% endif %}
                        >
                          {{ participant.name }}
                        </option>
                        {% endfor %}
                      </select>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}
      {% endfor %}

      <!-- Submit Button -->
      <div class="row">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <button type="submit" class="btn btn-primary btn-lg">
                💾 Save All Assignments
              </button>
              <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary btn-lg ms-2">
                Cancel
              </a>
              <span class="text-muted ms-3">
                Tip: Use the dropdown next to each team to assign an owner, then click "Save All Assignments"
              </span>
            </div>
          </div>
        </div>
      </div>
    </form>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Optional: Add confirmation before leaving if changes were made
    let formModified = false;
    
    document.querySelectorAll('select[name^="team_"]').forEach(select => {
      select.addEventListener('change', () => {
        formModified = true;
      });
    });
    
    window.addEventListener('beforeunload', (e) => {
      if (formModified) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
    
    document.getElementById('draftForm').addEventListener('submit', () => {
      formModified = false;  // Don't warn on submit
    });
  </script>
</body>
</html>
