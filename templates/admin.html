<!-- templates/admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - March Madness Madness</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a href="{{ url_for('home') }}" class="navbar-brand">March Madness Madness</a>
      <span class="badge bg-warning text-dark">Admin Panel</span>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row mb-4">
      <div class="col">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h1 class="h3 mb-0">Admin Dashboard <span class="badge bg-secondary">{{ year }}</span></h1>
          </div>
          <div class="d-flex gap-2 align-items-center">
            {% if years and years|length > 1 %}
            <form method="get" class="d-inline-block">
              <select name="year" class="form-select form-select-sm" onchange="this.form.submit()" style="min-width: 100px;">
                {% for y in years %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </form>
            {% endif %}
            <a href="{{ url_for('home') }}" class="btn btn-sm btn-outline-primary">â† Back to Home</a>
            <a href="{{ url_for('bracket') }}" class="btn btn-sm btn-outline-primary">Visual Bracket</a>
          </div>
        </div>
        <p class="text-muted">
          Manage participants, assign teams, and manually override game data.
        </p>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">ğŸ‘¥ Manage Participants</h5>
            <p class="card-text text-muted">
              Current: <strong>{{ participant_count }}</strong> participant(s)
              {% if participant_count == 16 %}
                <span class="badge bg-success">Ready!</span>
              {% elif participant_count < 16 %}
                <span class="badge bg-warning text-dark">Need {{ 16 - participant_count }} more</span>
              {% else %}
                <span class="badge bg-danger">Too many!</span>
              {% endif %}
            </p>
            <a href="{{ url_for('admin_participants') }}" class="btn btn-primary">Manage Participants</a>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">ğŸ¯ Assign Teams (Draft)</h5>
            <p class="card-text text-muted">
              Assign the 64 tournament teams to your 16 participants.
              {% if participant_count == 16 %}
                <span class="badge bg-success">Ready!</span>
              {% else %}
                <span class="badge bg-warning text-dark">Need 16 participants first</span>
              {% endif %}
            </p>
            {% if participant_count == 16 %}
              <a href="{{ url_for('admin_draft') }}" class="btn btn-primary">Start Draft</a>
            {% else %}
              <button class="btn btn-secondary" disabled>Start Draft</button>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-success">
          <div class="card-body">
            <h5 class="card-title">ğŸ² Simulate Tournament</h5>
            <p class="card-text text-muted">
              Simulate games with realistic scores for testing.
              <span class="badge bg-success">Testing Only</span>
            </p>
            <form method="post" action="{{ url_for('admin_simulate_tournament') }}" class="mb-2">
              <input type="hidden" name="year" value="{{ year }}">
              <input type="hidden" name="action" value="simulate_next">
              <button type="submit" class="btn btn-success btn-sm w-100">Simulate Next Round</button>
            </form>
            <form method="post" action="{{ url_for('admin_simulate_tournament') }}" onsubmit="return confirm('ğŸ² This will simulate all remaining games in the tournament. Continue?');">
              <input type="hidden" name="year" value="{{ year }}">
              <input type="hidden" name="action" value="simulate_all">
              <button type="submit" class="btn btn-outline-success btn-sm w-100">Simulate Entire Tournament</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-danger">
          <div class="card-body">
            <h5 class="card-title">ğŸ”„ Reset Test Data</h5>
            <p class="card-text text-muted">
              <strong>âš ï¸ Warning:</strong> This will delete ALL data and load fresh test data.
              <span class="badge bg-info text-dark">Testing Only</span>
            </p>
            <form method="post" action="{{ url_for('admin_reset_test_data') }}" onsubmit="return confirm('âš ï¸ Are you sure? This will DELETE all participants, teams, and games, then load 2024 test data with 16 participants and random team assignments. This cannot be undone!');">
              <button type="submit" class="btn btn-danger">Reset Test Data</button>
            </form>
            <small class="text-muted d-block mt-2">
              Loads: 16 participants, 2024 bracket, random draft
            </small>
          </div>
        </div>
      </div>
    </div>

    <h2 class="h5 mt-4 mb-3">ğŸ® Manual Game Management</h2>
    <p class="text-muted small">
      Use this section to manually override spreads or scores if automated fetching fails.
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if games %}
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>Active Games ({{ year }})</strong> â€” Scheduled or In Progress
        </div>
        <div class="card-body">
          {% for game in games %}
            <div class="card mb-3">
              <div class="card-header bg-light">
                <strong>Game #{{ game.id }}</strong> â€” 
                {{ game.round }} Round, {{ game.region }} Region
                <span class="badge bg-secondary ms-2">{{ game.status }}</span>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6>Matchup</h6>
                    <p>
                      <strong>{{ game.team1.name }}</strong> ({{ game.team1.seed }}) 
                      â€” Owner: {{ game.team1_owner.name if game.team1_owner else "â€”" }}
                      <br>
                      vs
                      <br>
                      <strong>{{ game.team2.name }}</strong> ({{ game.team2.seed }}) 
                      â€” Owner: {{ game.team2_owner.name if game.team2_owner else "â€”" }}
                    </p>
                    {% if game.spread %}
                      <p class="text-muted small">
                        Current Spread: {{ game.spread_label() }}
                      </p>
                    {% endif %}
                    {% if game.team1_score is not none %}
                      <p class="text-muted small">
                        Current Score: {{ game.score_label() }}
                      </p>
                    {% endif %}
                  </div>

                  <div class="col-md-6">
                    <!-- Set Spread Form -->
                    <form method="post" action="{{ url_for('admin_update_game') }}" class="mb-3">
                      <input type="hidden" name="game_id" value="{{ game.id }}">
                      <input type="hidden" name="action" value="set_spread">
                      <h6>Set/Update Spread</h6>
                      <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">Spread</span>
                        <input type="number" name="spread" step="0.5" class="form-control" 
                               placeholder="4.5" value="{{ game.spread if game.spread else '' }}">
                      </div>
                      <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">Favorite</span>
                        <select name="favorite_id" class="form-select">
                          <option value="">-- Select Favorite --</option>
                          <option value="{{ game.team1.id }}" {% if game.spread_favorite_team_id == game.team1.id %}selected{% endif %}>
                            {{ game.team1.name }}
                          </option>
                          <option value="{{ game.team2.id }}" {% if game.spread_favorite_team_id == game.team2.id %}selected{% endif %}>
                            {{ game.team2.name }}
                          </option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-sm btn-primary">Update Spread</button>
                    </form>

                    <hr>

                    <!-- Set Scores Form -->
                    <form method="post" action="{{ url_for('admin_update_game') }}">
                      <input type="hidden" name="game_id" value="{{ game.id }}">
                      <input type="hidden" name="action" value="set_scores">
                      <h6>Set/Update Scores</h6>
                      <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">{{ game.team1.name }}</span>
                        <input type="number" name="team1_score" class="form-control" 
                               placeholder="Score" value="{{ game.team1_score if game.team1_score is not none else '' }}">
                      </div>
                      <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">{{ game.team2.name }}</span>
                        <input type="number" name="team2_score" class="form-control" 
                               placeholder="Score" value="{{ game.team2_score if game.team2_score is not none else '' }}">
                      </div>
                      <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">Status</span>
                        <select name="status" class="form-select">
                          <option value="Scheduled" {% if game.status == 'Scheduled' %}selected{% endif %}>Scheduled</option>
                          <option value="In Progress" {% if game.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                          <option value="Final" {% if game.status == 'Final' %}selected{% endif %}>Final</option>
                        </select>
                      </div>
                      <button type="submit" class="btn btn-sm btn-success">Update Scores</button>
                      <small class="text-muted d-block mt-1">
                        âš ï¸ If status is set to "Final", winner will be automatically evaluated.
                      </small>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">
        No active games found for {{ year }}. All games may be completed, or the tournament hasn't started yet.
      </div>
    {% endif %}

    <div class="mt-4">
      <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">â† Back to Bracket</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
