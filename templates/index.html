<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>March Madness Madness</title>

    <!-- Bootstrap for quick, clean defaults (optional but helpful) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Our tiny stylesheet (safe to keep empty for now) -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <span class="navbar-brand mb-0 h1">March Madness Madness - Table View</span>
        <div>
          <a href="{{ url_for('home') }}" class="btn btn-sm btn-outline-light me-2">Visual Bracket</a>
          {% if is_local %}
          <a href="{{ url_for('admin') }}" class="btn btn-sm btn-outline-light">Admin</a>
          {% endif %}
        </div>
        {% for g in games %}
        <div class="game-card">
          <div class="game-header">
            <div class="game-round">Round of {{ g.round }}</div>
            {% if g.game_time %}
            <div class="game-time">{{ format_game_time(g.game_time) }}</div>
            {% endif %}
          </div>
          <div class="matchup-container">
            <div class="team-block">
              <div class="team-name">
                {{ g.team1.name if g.team1 else "TBD" }}
                {% if g.team1 %}
                <span class="team-seed">({{ g.team1.seed }})</span>
                {% endif %}
              </div>
              {% if g.team1 %}
              <div class="team-owner">{{ g.team1_owner.name if g.team1_owner else "‚Äî" }}</div>
              {% endif %}
              {% if g.team1_score is not none %}
              <div class="team-score {% if g.status == 'Final' and g.winner_id == g.team1_id %}winner{% endif %}">
                {{ g.team1_score }}
              </div>
              {% endif %}
            </div>
            <div class="vs-divider">VS</div>
            <div class="team-block">
              <div class="team-name">
                {{ g.team2.name if g.team2 else "TBD" }}
                {% if g.team2 %}
                <span class="team-seed">({{ g.team2.seed }})</span>
                {% endif %}
              </div>
              {% if g.team2 %}
              <div class="team-owner">{{ g.team2_owner.name if g.team2_owner else "‚Äî" }}</div>
              {% endif %}
              {% if g.team2_score is not none %}
              <div class="team-score {% if g.status == 'Final' and g.winner_id == g.team2_id %}winner{% endif %}">
                {{ g.team2_score }}
              </div>
              {% endif %}
            </div>
          </div>
          <div class="game-footer">
            <div>
              <span class="status-badge {% if g.status == 'In Progress' %}status-live{% elif g.status == 'Final' %}status-final{% else %}status-scheduled{% endif %}">
                {{ g.status }}
              </span>
              {% if g.spread %}
              <span class="spread-badge">{{ g.spread_label() }}</span>
              {% endif %}
            </div>
            {% if g._live_owner_leader %}
            <span class="leader-badge">Leader: {{ g._live_owner_leader.name }}</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Upcoming Games Section -->
    {% if upcoming_games %}
    <div class="section-card">
      <div class="section-header upcoming">
        <span>üìÖ</span>
        <span>Upcoming Games</span>
      </div>
      <div class="region-subsection">
        {% for g in upcoming_games %}
        <div class="game-card">
          <div class="game-header">
            <div class="game-round">{{ g.region }} - Round of {{ g.round }}</div>
            {% if g.game_time %}
            <div class="game-time">{{ format_game_time(g.game_time) }}</div>
            {% endif %}
          </div>
          <div class="matchup-container">
            <div class="team-block">
              <div class="team-name">
                {{ g.team1.name if g.team1 else "TBD" }}
                {% if g.team1 %}
                <span class="team-seed">({{ g.team1.seed }})</span>
                {% endif %}
              </div>
              {% if g.team1 %}
              <div class="team-owner">{{ g.team1_owner.name if g.team1_owner else "‚Äî" }}</div>
              {% endif %}
            </div>
            <div class="vs-divider">VS</div>
            <div class="team-block">
              <div class="team-name">
                {{ g.team2.name if g.team2 else "TBD" }}
                {% if g.team2 %}
                <span class="team-seed">({{ g.team2.seed }})</span>
                {% endif %}
              </div>
              {% if g.team2 %}
              <div class="team-owner">{{ g.team2_owner.name if g.team2_owner else "‚Äî" }}</div>
              {% endif %}
            </div>
          </div>
          <div class="game-footer">
            <span class="status-badge status-scheduled">{{ g.status }}</span>
            {% if g.spread %}
            <span class="spread-badge">{{ g.spread_label() }}</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </select>
      <noscript>
        <button class="btn btn-sm btn-primary" type="submit">Go</button>
      </noscript>
    </form>
  {% endif %}
</div>


      {% if grouped %}
      <!-- Iterate regions (East/West for our seed) -->
      {% for region, rounds in grouped.items() %}
      <div class="card mb-4 shadow-sm">
        <div class="card-header"><strong>Region:</strong> {{ region }}</div>
        <div class="card-body">
          <!-- Iterate rounds inside each region -->
          {% for round_label, games in rounds.items() %}
          <h2 class="h6 text-uppercase text-muted">
            Round of {{ round_label }}
          </h2>
          <div class="table-responsive mb-3">
            <table class="table table-sm align-middle games-table">
              <thead>
                <tr>
                  <th>Game Time</th>
                  <th>Team 1</th>
                  <th>Team 2</th>
                  <th>Spread</th>
                  <th>Status</th>
                  <th>Leader vs Spread</th>
                </tr>
              </thead>
              <tbody>
                {% for g in games %}
                <tr>
                  <td>
                    {% if g.game_time %}
                    <div class="small">{{ format_game_time(g.game_time) }}</div>
                    {% else %}
                    <span class="text-muted small">TBD</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="fw-semibold">
                      {{ g.team1.name }}
                      <span class="text-muted">(Seed {{ g.team1.seed }})</span>
                    </div>
                    <div class="text-muted small">
                      Owner: {{ g.team1_owner.name if g.team1_owner else "‚Äî" }}
                    </div>
                  </td>
                  <td>
                    <div class="fw-semibold">
                      {{ g.team2.name }}
                      <span class="text-muted">(Seed {{ g.team2.seed }})</span>
                    </div>
                    <div class="text-muted small">
                      Owner: {{ g.team2_owner.name if g.team2_owner else "‚Äî" }}
                    </div>
                  </td>
                  <td>
                    {% if g.spread_label() %}
                    <span class="badge text-bg-info">{{ g.spread_label() }}</span>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge text-bg-light">{{ g.status }}</span>
                    {% if g.score_label() %}
                    <div class="small text-muted">
                      Score: {{ g.score_label() }}
                    </div>
                    {% endif %}
                  </td>
                  <td>
                    {% if g.status == "In Progress" and g._live_owner_leader %}
                    <span class="badge text-bg-success">
                      {{ g._live_owner_leader.name }}
                    </span>
                    {% elif g.status == "In Progress" %}
                    <span class="text-muted">Calculating‚Ä¶</span>
                    {% else %}
                    <span class="text-muted">‚Äî</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not todays_games_by_region and not upcoming_games and not past_games %}
    <div class="section-card">
      <div class="empty-state">
        <div class="empty-state-icon">üèÄ</div>
        <h3>No Games Found</h3>
        <p>No games are available for {{ selected_year }}. Try running <code>python seed_data.py</code> to populate the database.</p>
      </div>
    </div>
    {% endif %}
  </div>

    <!-- Optional JS (we'll use this later for auto-refresh, etc.) -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
      // Set preference when user clicks "Visual Bracket" button
      // This prevents auto-redirect back to table view on small screens
      document.addEventListener('DOMContentLoaded', function() {
        const bracketLink = document.querySelector('a[href="{{ url_for("home") }}"]');
        if (bracketLink) {
          bracketLink.addEventListener('click', function() {
            sessionStorage.setItem('viewPreference', 'bracket');
          });
        }
      });
    </script>
  </body>
</html>
